apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
- patch: |-
    - op: add
      path: /spec/kubeadmConfigSpec/joinConfiguration/nodeRegistration/ignorePreflightErrors/-
      value: "DirAvailable--etc-kubernetes-manifests"
    - op: add
      path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
      value: |-
        mkdir -p /etc/kubernetes/manifests
        ctr images pull ghcr.io/kube-vip/kube-vip:v0.4.2 && ctr run --rm --net-host ghcr.io/kube-vip/kube-vip:v0.4.2 vip /kube-vip manifest pod --interface bond0 --address {{ .controlPlaneEndpoint }} --controlplane --arp --leaderElection --metal --metalKey {{ .apiKey }} --metalProjectID ${PROJECT_ID} > /etc/kubernetes/manifests/kube-vip.yaml
  target:
    kind: KubeadmControlPlane
